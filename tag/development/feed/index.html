<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Ikke&#039;s blog &#187; Development</title>
	<atom:link href="http://eikke.com/tag/development/feed/" rel="self" type="application/rss+xml" />
	<link>http://eikke.com</link>
	<description>&#039;cause this is what I do</description>
	<lastBuildDate>Sun, 13 Feb 2011 14:58:55 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>http://wordpress.org/?v=3.4.1</generator>
		<item>
		<title>Scala tail recursion and decompiler adventures</title>
		<link>http://eikke.com/scala-tail-recursion-decompiler/</link>
		<comments>http://eikke.com/scala-tail-recursion-decompiler/#comments</comments>
		<pubDate>Wed, 12 Aug 2009 22:31:03 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Technology]]></category>
		<category><![CDATA[functional programming]]></category>
		<category><![CDATA[java]]></category>
		<category><![CDATA[scala]]></category>

		<guid isPermaLink="false">http://eikke.com/?p=129</guid>
		<description><![CDATA[I've been into Scala lately. More about it will follow later, but there's something I found out which I really like.

Last couple of days I've been writing some very basic Scala snippets, containing constructs which would be non-trivial or 'unusual' to write in Java, compile it to a class file, and then use a Java decompiler to figure out how the Scala compiler maps those constructs on the JVM.

There's one thing which took my immediate attention: looks like (basic) tail-recursive functions are optimized into while-loops!]]></description>
			<content:encoded><![CDATA[<p>I&#8217;ve been into <a href="http://www.scala-lang.org">Scala</a> lately. More about it will follow later, but there&#8217;s something I found out which I really like.</p>
<p>Last couple of days I wrote some very basic Scala snippets, containing constructs which would be non-trivial or &#8216;unusual&#8217; to write in <a href="http://java.sun.com">Java</a>, compile it to a class file, and then use a <a href="http://java.decompiler.free.fr">Java decompiler</a> to figure out how the Scala compiler maps those constructs to JVM bytecodes.</p>
<p>There&#8217;s one thing which took my attention: looks like (basic) tail-recursive functions are optimized into while-loops! This only happens if the last call of a function is a call to itself (the most basic form of tail recursion), but it&#8217;s an interesting feature anyway&#8230; No more need to put socket accept handling in an infinite while loop <img src='http://eikke.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /><br />
<span id="more-129"></span><br />
A little demo. First, here&#8217;s a Scala object which implements a very basic &#8216;reduce&#8217; function:</p>
<pre>
object Reducer {
  def reduce[T, V](fun: (V, T) => V, values: List[T], initial: V): V = {
    if(values isEmpty)
      return initial
    val next = fun(initial, values head)
    return reduce(fun, values tail, next)
  }

  def main(args: Array[String]): Unit = {
    val values = List(1, 2, 3, 4)
    val sum = reduce[Int, Int]((x, y) => x + y, values, 0)
    println("Result: " + sum)
  }
}
</pre>
<p>We can compile and run this, and it&#8217;ll output the expected result &#8217;10&#8242;:</p>
<pre>MacBook:reduce nicolas $ scalac Reducer.scala 
MacBook:reduce nicolas $ scala Reducer
Result: 10</pre>
<p>Now we can open the generated class files in JD. There are a couple of them (it&#8217;s interesting to take a look at all of them and figure out what they represent exactly), but in this case we need &#8216;Reducer$.class&#8217;, which contains the implementations of our public functions, including &#8216;reduce&#8217;.</p>
<p>Here&#8217;s the Java version of the &#8216;reduce&#8217; function:</p>
<pre>public &lt;T, V&gt; V reduce(Function2&lt;V, T, V&gt; fun, List&lt;T&gt; values, V initial)
{
  while (true)
  {
    if (values.isEmpty())
      return initial;
    Object next = fun.apply(initial, values.head());
    initial = next;
    values = values.tail();
  }
}
</pre>
<p>&#8216;Function2&#8242; is a built-in Scala type which represents a function taking 2 parameters. As you can see, this code does exactly the same as our Scala version and is most likely the way we&#8217;d write the code manually as well (the only thing I don&#8217;t get is why &#8216;next&#8217; is an Object and not a &#8216;V&#8217;, I might figure that out later), but without forcing us to write the imperative code, whilst still producing bytecodes which will most likely show the best performance on the JVM (which currently has no tail recursion optimization support (although <a href="http://openjdk.java.net/projects/mlvm/subprojects.html#TailCalls">that might change one day</a>)).</p>
<p>I like it <img src='http://eikke.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /> </p>
<p>[update]<br />
For reference, here&#8217;s a slightly more Scala-ish implementation of <em>reduce</em>, showing the same time performance characteristics during some basic profiling. I was not able to get JD nor jad to generate any usable decompiled code though:</p>
<pre>
def reduce[T, V](fun: (V, T) => V, values: List[T], initial: V): V = {
    values match {
        case List() => initial;
        case head :: tail => reduce(fun, tail, fun(initial, head))
    }
}
</pre>
<p>It uses Scala&#8217;s &#8220;List&#8221; pattern matching functionality.</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/scala-tail-recursion-decompiler/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
		</item>
		<item>
		<title>Re: Python recursion performance test</title>
		<link>http://eikke.com/re-python-recursion-performance-test/</link>
		<comments>http://eikke.com/re-python-recursion-performance-test/#comments</comments>
		<pubDate>Thu, 16 Jul 2009 01:00:57 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Technology]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://eikke.com/?p=113</guid>
		<description><![CDATA[(This is a reply on a post by Ahmed Soliman on recursion performance in (C)Python, and CPython function call overhead in general. I started to write this as a comment on his post, but it turned out much longer, so sending it over here in the end.) Hey, As discussed before, this is not a [...]]]></description>
			<content:encoded><![CDATA[<p>(This is a reply on a <a href="http://www.ahmedsoliman.com/2009/07/15/python-recursion-performance-test/" title="Ahmed Soliman: Python recursion performance test">post</a> by <a href="http://www.ahmedsoliman.com" title="Ahmed Soliman">Ahmed Soliman</a> on recursion performance in (C)Python, and CPython function call overhead in general. I started to write this as a comment on his post, but it turned out much longer, so sending it over here in the end.)</p>
<p>Hey,</p>
<p>As discussed before, this is not a fair comparison, since the non-recursive version is much &#8216;smarter&#8217; than the recursive one: it calculates values and will never recalculates them, whilst the recursive version calculates everything over and over again.</p>
<p>Adding some simple memoization helps a lot. First, my testing code:<br />
<span id="more-113"></span><br />
<script src="http://gist.github.com/148082.js"></script></p>
<p>Here are the benchmarks on my MacBook Pro Intel Core2Duo 2.33GHz with 3GB RAM (running quite a lot of applications). Do note the &#8216;dumb&#8217; version calculates <em>fib(35)</em>, whilst the slightly optimized versions, which still use recursion but much less recursive calls (as they should) or your second version calculate <em>fib(150)</em>.</p>
<p>Using MacOS X 10.5.6 stock CPython 2.5.1:</p>
<pre>
MacBook:Projects nicolas $ python -V
Python 2.5.1

MacBook:Projects nicolas $ python fib.py 35 150
fib(35) = 9227465
Calculation took 12.8542108536 seconds

Calculating the amount of recursive calls to calculate fib(35)
Calculating fib(35) = 9227465 took 29860703 calls

fib2(150) = 9969216677189303386214405760200
Calculation took 0.00020694732666 seconds

memoize_dict(fib)(150) = 9969216677189303386214405760200
Calculation took 0.00141310691833 seconds

memoize_constant_list(151, fib)(150) = 9969216677189303386214405760200
Calculation took 0.000310182571411 seconds
</pre>
<p>Overall it looks like <em>fib2</em> and <em>memoize_constant_list</em> perform fairly similar, I guess function call overhead and <em>list.append</em> have a similar influence on performance in this case.</p>
<p>Using Jython 2.5.0 from the binary distribution on the Java HotSpot 64bit Server VM as shipped for OS X 10.5.6:</p>
<pre>
MacBook:Projects nicolas $ ./Jython/jython2.5.0/jython -V 
Jython 2.5.0

MacBook:Projects nicolas $ ./Jython/jython2.5.0/jython fib.py 35 150
fib(35) = 9227465
Calculation took 12.5539999008 seconds

Calculating the amount of recursive calls to calculate fib(35)
Calculating fib(35) = 9227465 took 29860703 calls

fib2(150) = 9969216677189303386214405760200
Calculation took 0.0519998073578 seconds

memoize_dict(fib)(150) = 9969216677189303386214405760200
Calculation took 0.00399994850159 seconds

memoize_constant_list(151, fib)(150) = 9969216677189303386214405760200
Calculation took 0.00300002098083 seconds
</pre>
<p>The &#8216;dumb&#8217; <em>fib</em> implementation performs similar in both CPython and Jython. Jython performs significantly less good on the other implementations though, but maybe todays <a href="http://journal.thobe.org/2009/07/improving-performance-in-jython.html">news</a> could help here, not sure how much locking on <em>dict</em> and <em>list</em> access Jython introduces.</p>
<p>Finally, using <a href="http://code.google.com/p/unladen-swallow/">Unladen Swallow</a> 2009Q2, self-compiled from SVN on the same system, using standard settings:</p>
<pre>
MacBook:Projects nicolas $ ./unladen-swallow/unladen-2009Q2-inst/bin/python -V
Python 2.6.1

MacBook:Projects nicolas $ ./unladen-swallow/unladen-2009Q2-inst/bin/python fib.py 35 150
fib(35) = 9227465
Calculation took 12.2675719261 seconds

Calculating the amount of recursive calls to calculate fib(35)
Calculating fib(35) = 9227465 took 29860703 calls

fib2(150) = 9969216677189303386214405760200
Calculation took 0.000118970870972 seconds

memoize_dict(fib)(150) = 9969216677189303386214405760200
Calculation took 0.000972986221313 seconds

memoize_constant_list(151, fib)(150) = 9969216677189303386214405760200
Calculation took 0.00036096572876 seconds
</pre>
<p>which is similar to, slighly better or slightly worse than the CPython run, and when enforcing JIT (which introduces a significant startup time, which is not measured here):</p>
<pre>
MacBook:Projects nicolas $ ./unladen-swallow/unladen-2009Q2-inst/bin/python -j always fib.py 35 150
fib(35) = 9227465
Calculation took 14.6129109859 seconds

Calculating the amount of recursive calls to calculate fib(35)
Calculating fib(35) = 9227465 took 29860703 calls

fib2(150) = 9969216677189303386214405760200
Calculation took 0.0432291030884 seconds

memoize_dict(fib)(150) = 9969216677189303386214405760200
Calculation took 0.0363459587097 seconds

memoize_constant_list(151, fib)(150) = 9969216677189303386214405760200
Calculation took 0.0335609912872 seconds
</pre>
<p>which, to my surprise, performs pretty worse than the default settings.</p>
<p>Overall: your first implementation performs tons and tons of function calls, whilst the second one, which resembles <em>memoize_list_fib</em> in my code (which is recursive), performs significantly less function calls and in the end <em>memoize_list_fib</em> performs almost as good as your second version (it performs +- the same number of function calls as the number of times you&#8217;re going through your loop).</p>
<p>So whilst I do agree function calls in Python are reasonably slow compared to plain C function calls (which is just a jmp, no frame handling etc. etc. required), your comparison between your recursive and non-recursive implementation is completely unfair, and even if calculating <em>fib(35)</em> takes several seconds, consider you&#8217;re doing a pretty impressive 29860703 function calls to perform the calculation.</p>
<p>Time to get some sleep.</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/re-python-recursion-performance-test/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>First Clojure experiments</title>
		<link>http://eikke.com/first-clojure-experiments/</link>
		<comments>http://eikke.com/first-clojure-experiments/#comments</comments>
		<pubDate>Sun, 12 Jul 2009 00:28:25 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Technology]]></category>
		<category><![CDATA[clojure]]></category>
		<category><![CDATA[jvm]]></category>

		<guid isPermaLink="false">http://eikke.com/?p=109</guid>
		<description><![CDATA[Some weeks ago I attended JavaOne (a pretty neat conference, even for non-Java-heads like me) and got in touch with several non-Java languages running on the JVM (nothing really new next to Project Fortress, but I never got into most for real). Since I wanted to learn some language not resembling any other I already [...]]]></description>
			<content:encoded><![CDATA[<p>Some weeks ago I attended <a href="http://java.sun.com/javaone/" title="JavaOne">JavaOne</a> (a pretty neat conference, even for non-Java-heads like me) and got in touch with several non-Java languages running on the <a href="http://en.wikipedia.org/wiki/Java_Virtual_Machine" title="Wikipedia - Java Virtual Machine"><abbr title="Java Virtual Machine">JVM</abbr></a> (nothing really new next to <a href="http://projectfortress.sun.com/Projects/Community" title="Project Fortress">Project Fortress</a>, but I never got into most for real).</p>
<p>Since I wanted to learn some language not resembling any other I already know (even a little), I decided some hours ago to start digging into Clojure, which is a <a href="http://en.wikipedia.org/wiki/LISP" title="Wikipedia - LISP"><abbr title="LISt Processing">LISP</abbr></a> dialect running on the JVM using <a href="http://en.wikipedia.org/wiki/Software_transactional_memory" title="Wikipedia - Software transactional memory"><abbr title="Software Transactional Memory">STM</abbr></a> (Software Transactional Memory) and created with concurrency in mind. Check the <a href="http://clojure.org/" title="Clojure">website</a> for more information.<br />
<span id="more-109"></span></p>
<p>After some hacking I got a first &#8216;application&#8217; running. Since recently there&#8217;s been some little meme at work regarding echo servers, I decided to write a very basic line-oriented echo server in Clojure.</p>
<p>The result is a server using one thread per connection which just sends back lines to a connected client as-is. Nothing fancy, but might be a useful start for developing basic network applications using Clojure.</p>
<p>Enjoy!</p>
<p><script src="http://gist.github.com/145449.js"></script></p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/first-clojure-experiments/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		</item>
		<item>
		<title>Erlang, Python and Twisted mashup using TwOTP</title>
		<link>http://eikke.com/erlang-python-and-twisted-mashup-using-twotp/</link>
		<comments>http://eikke.com/erlang-python-and-twisted-mashup-using-twotp/#comments</comments>
		<pubDate>Sun, 19 Apr 2009 19:03:30 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Technology]]></category>
		<category><![CDATA[erlang]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[twisted]]></category>
		<category><![CDATA[twotp]]></category>

		<guid isPermaLink="false">http://eikke.com/?p=90</guid>
		<description><![CDATA[Recently, I&#8217;ve been toying around with Erlang again. After creating some simple apps I wanted to integrate some Erlang code inside a Python application (since that&#8217;s still my favorite day-to-day language, it&#8217;s used at work and I&#8217;m sort-of convinced Erlang would be a good choice for several of the applications we need to develop, integrated [...]]]></description>
			<content:encoded><![CDATA[<p>Recently, I&#8217;ve been toying around with <a href="http://erlang.org">Erlang</a> again. After creating some simple apps I wanted to integrate some Erlang code inside a <a href="http://www.python.org">Python</a> application (since that&#8217;s still my favorite day-to-day language, it&#8217;s used at work and I&#8217;m sort-of convinced Erlang would be a good choice for several of the applications we need to develop, integrated with our existing Python code). The most obvious solution would be to use an Erlang port, but this is IMHO rather cumbersome: it requires a developer to define a messaging format, parsing code for incoming messages, etc. There&#8217;s a <a href="http://www.kazmier.net/computer/port-howto/">tutorial</a> available if you want to take this route.</p>
<p>A more elegant solution is creating a node using Python, similar to <a href="http://erlang.org/doc/apps/jinterface/index.html">JInterface</a> and equivalents. Luckily there&#8217;s an existing project working on a library to create Erlang nodes using Python and <a href="http://www.twistedmatrix.com">Twisted</a>: <a href="https://code.launchpad.net/twotp">TwOTP</a>.</p>
<p>One downside: it&#8217;s rather underdocumented&#8230; So here&#8217;s a very quick demo how to call functions on an Erlang node from within a Twisted application.</p>
<p>First of all we&#8217;ll create 2 Erlang functions: one which returns a simple &#8220;Hello&#8221; message, one which uses an extra process to return &#8216;pong&#8217; messages on calls to &#8216;ping&#8217;, and counts those.</p>
<p>The code:</p>
<p><code>
<pre>-module(demo).
-export([hello/1, ping/0, start/0]).

hello(Name) ->
    Message = "Hello, " ++ Name,
    io:format(Message ++ "~n", []),
    Message.

ping_loop(N) ->
    receive
        {get_id, From} ->
            From ! {pong, N},
            ping_loop(N + 1)
    end.

ping() ->
    pingsrv ! {get_id, self()},
    receive
        {pong, N} -&gt; ok
    end,
    {pong, N}.

start() ->
    Pid = spawn_link(fun() -> ping_loop(1) end),
    register(pingsrv, Pid).
</pre>
<p></code></p>
<p>This should be straight-forward if you&#8217;re familiar with Erlang (which I assume).</p>
<p>The Python code is not that hard to get either: it follows the basic Twisted pattern. First one should create a connection to EPMD, the Erlang Port Mapper Daemon (used to find other nodes), then a connection to the server node should be created, and finally functions can be called (calls happen the same way as Erlang&#8217;s <a href="http://erlang.org/doc/man/rpc.html">RPC module</a>).</p>
<p>Here&#8217;s the code. I&#8217;d advise to read it bottom-to-top:</p>
<p><code>
<pre>import sys

from twisted.internet import reactor
import twotp

def error(e):
    '''A generic error handler'''
    print 'Error:'
    print e
    reactor.stop()

def do_pingpong(proto):
    def handle_pong(result):
        # Parse the result
        # 'ping' returns a tuple of an atom ('pong') and an integer (the pong
        # id)
        # In TwOTP, an Atom object has a 'text' attribute, which is the string
        # form of the atom
        text, id_ = result[0].text, result[1]
        print 'Got ping result: %s %d' % (text, id_)
        # Recurse
        reactor.callLater(1, do_pingpong, proto)

    # Call the 'ping' function of the 'demo' module
    d = proto.factory.callRemote(proto, 'demo', 'ping')
    # Add an RPC call handler
    d.addCallback(handle_pong)
    # And our generic error handler
    d.addErrback(error)

def call_hello(proto, name):
    def handle_hello(result):
        print 'Got hello result:', result
        # Erlang strings are lists of numbers
        # The default encoding is Latin1, this might need to be changed if your
        # Erlang node uses another encoding
        text = ''.join(chr(c) for c in result).decode('latin1')
        print 'String form:', text
        # Start pingpong loop
        do_pingpong(proto)

    # Call the 'hello' function of the 'demo' module, and pass in argument
    # 'name'
    d = proto.factory.callRemote(proto, 'demo', 'hello', name)
    # Add a callback for this function call
    d.addCallback(handle_hello)
    # And our generic error handler
    d.addErrback(error)

def launch(epmd, remote, name):
    '''Entry point of our demo application'''
    # Connect to a node. This returns a deferred
    d = epmd.connectToNode(remote)
    # Add a callback, called when the connection to the node is established
    d.addCallback(call_hello, name)
    # And add our generic error handler
    d.addErrback(error)

def main():
    remote = sys.argv[1]
    name = sys.argv[2]
    # Read out the Erlang cookie value
    cookie = twotp.readCookie()
    # Create a name for this node
    this_node = twotp.buildNodeName('demo_client')
    # Connect to EPMD
    epmd = twotp.OneShotPortMapperFactory(this_node, cookie)
    # Call our entry point function when the Twisted reactor is started
    reactor.callWhenRunning(launch, epmd, remote, name)
    # Start the reactor
    reactor.run()

if __name__ == '__main__':
    main()</pre>
<p></code></p>
<p>Finally, to run it, you should first start a server node, and run the &#8216;pingsrv&#8217; process:</p>
<p><code>
<pre>MacBook:pyping nicolas$ erl -sname test@localhost
Erlang (BEAM) emulator version 5.6.5 [source] [async-threads:0] [hipe] [kernel-poll:false]

Eshell V5.6.5  (abort with ^G)
(test@localhost)1> c(demo).
{ok,demo}
(test@localhost)2> demo:start().
true</pre>
<p></code></p>
<p>Notice we started <em>erl</em> providing <em>test@localhost</em> as short node name.</p>
<p>Now we can launch our client:</p>
<p><code>
<pre>(pythonenv)MacBook:pyping nicolas$ python hello.py 'test' Nicolas
Got hello result: [72, 101, 108, 108, 111, 44, 32, 78, 105, 99, 111, 108, 97, 115]
String form: Hello, Nicolas
Got ping result: pong 1
Got ping result: pong 2
Got ping result: pong 3</pre>
<p></code></p>
<p>&#8216;test&#8217; is the shortname of the server node.</p>
<p>You can stop the ping loop using <em>CTRL-C</em>. If you restart the client afterwards, you can see the ping IDs were retained:</p>
<p><code>
<pre>(pythonenv)MacBook:pyping nicolas$ python hello.py 'test' Nicolas
Got hello result: [72, 101, 108, 108, 111, 44, 32, 78, 105, 99, 111, 108, 97, 115]
String form: Hello, Nicolas
Got ping result: pong 4
Got ping result: pong 5</pre>
<p></code></p>
<p>That&#8217;s about it. Using TwOTP you can also develop a node which exposes functions, which can be called from an Erlang node using <em>rpc:call/4</em>. Check the documentation provided with TwOTP for a basic example of this feature.</p>
<p>Combining Erlang applications as distributed, fault tolerant core infrastructure and Python/Twisted applications for &#8216;everyday coding&#8217; can be an interesting match in several setups, an TwOTP provides all required functionalities to integrate the 2 platforms easily.</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/erlang-python-and-twisted-mashup-using-twotp/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		</item>
		<item>
		<title>Python factory-like type instances</title>
		<link>http://eikke.com/python-factory-like-type-instances/</link>
		<comments>http://eikke.com/python-factory-like-type-instances/#comments</comments>
		<pubDate>Mon, 11 Feb 2008 19:31:20 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Technology]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://eikke.com/python-factory-like-type-instances/</guid>
		<description><![CDATA[When designing applications or libraries, sometimes you need to be able to create instances of a certain interface (in a liberal sense) at runtime without knowing at write/compile time which specific implementation (class) you&#8217;ll need to use, as this could depend on runtime variables. An example of this is an interface providing some functionality which [...]]]></description>
			<content:encoded><![CDATA[<p>When designing applications or libraries, sometimes you need to be able to create instances of a certain interface (in a liberal sense) at runtime without knowing at write/compile time which specific implementation (class) you&#8217;ll need to use, as this could depend on runtime variables.</p>
<p>An example of this is an interface providing some functionality which should be implemented differently on different platforms, eg Linux and Windows.</p>
<p>There are some standard patterns how to achieve this. One of them is the <a href="http://en.wikipedia.org/wiki/Factory_method_pattern" title="Wikipedia: Factory method pattern">factory pattern</a>, which works somewhat like this <a href="http://www.python.org" title="Python">Python</a> example (let&#8217;s pretend &#8216;PLATFORM&#8217; is &#8216;linux2&#8242; or &#8216;win32&#8242;, ie sys.platform):</p>
<pre>#Pretend we use sys.platform instead of PLATFORM where we use it
PLATFORM = 'linux2'

class FooBase(object):
    def say_foo(self):
        print 'foo'

class PlatformFoo(FooBase):
    def say_platform_foo(self):
        raise NotImplementedError

    @staticmethod
    def get_class():
        #Several ways to get this (dict, introspection, if-tree,...), pick yours
        klass = {
            'linux2': LinuxFoo,
            'win32': WindowsFoo,
        }.get(PLATFORM, None)
        if not klass:
            raise Exception, 'Platform not supported'
        return klass

class WindowsFoo(PlatformFoo):
    def say_platform_foo(self):
        print 'win32 foo'

class LinuxFoo(PlatformFoo):
    def say_platform_foo(self):
        print 'linux foo'

def main():
    foo_class = PlatformFoo.get_class()
    foo = foo_class()
    foo.say_platform_foo()

if __name__ == '__main__':
    main()</pre>
<p>Executing this code will, as expected, write &#8216;linux foo&#8217; to the console. Obviously we could not return the platform-specific class in a PlatformFoo function, but an actual instance, up to you.</p>
<p>Python allows you to handle this situation somewhat nicer though, without introducing any intermediate functions, by using metaclasses.</p>
<p><span id="more-61"></span></p>
<p>I won&#8217;t explain what metaclasses are here, or how they work, there are several resources on the internet explaining them. Let&#8217;s just get to the code:</p>
<pre>#Pretend we use sys.platform instead of PLATFORM where we use it
PLATFORM = 'linux2'

class FooBase(object):
    def say_foo(self):
        print 'foo'

    def say_platform_foo(self):
        raise NotImplementedError

class WindowsFoo(FooBase):
    def say_platform_foo(self):
        print 'win32 foo'
         
class LinuxFoo(FooBase):
    def say_platform_foo(self):
        print 'linux foo'


class FooMeta(type):
    def __new__(cls, name, bases, attrs):
        #Several ways to get this (dict, introspection, if-tree,...), pick yours
        klass = {
            'linux2': LinuxFoo,
            'win32': WindowsFoo,
        }.get(PLATFORM, None)
        if not klass:
            raise Exception, 'Platform not supported'
        return klass

class Foo:
    __metaclass__ = FooMeta


def main():
    foo = Foo()
    foo.say_platform_foo()

if __name__ == '__main__':
    main()</pre>
<p>See we don&#8217;t need any getter-function here, but we can just create a &#8216;Foo&#8217; instance? The resulting object will be a &#8216;LinuxFoo&#8217; or a &#8216;WindowsFoo&#8217; as expected, depending on the value of &#8216;PLATFORM&#8217;. The above code also displays &#8216;linux foo&#8217;.</p>
<p>There&#8217;s something nifty about it too: you don&#8217;t loose any class inheritance information:</p>
<pre>In [1]: from test2 import Foo, LinuxFoo, FooBase

In [2]: f = Foo()

In [3]: f.say_platform_foo()
linux foo

In [4]: type(f)
Out[4]: <class 'test2.LinuxFoo'>

In [5]: isinstance(f, LinuxFoo)
Out[5]: True

In [6]: isinstance(f, FooBase)
Out[6]: True

In [7]: isinstance(f, Foo)
Out[7]: True</pre>
<p>This shouldn&#8217;t surprise you, as &#8216;Foo&#8217; actually became an alias for &#8216;LinuxFoo&#8217;.</p>
<p>Maybe this pattern will be useful in one of your projects one day, who know <img src='http://eikke.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /> </p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/python-factory-like-type-instances/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>How not to write Python code</title>
		<link>http://eikke.com/how-not-to-write-python-code/</link>
		<comments>http://eikke.com/how-not-to-write-python-code/#comments</comments>
		<pubDate>Fri, 08 Feb 2008 20:50:16 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Technology]]></category>
		<category><![CDATA[python]]></category>

		<guid isPermaLink="false">http://eikke.com/how-not-to-write-python-code/</guid>
		<description><![CDATA[Lately I&#8217;ve been reading some rather unclean Python code. Maybe this is mainly because the author(s) of the code had no in-depth knowledge of the Python language itself, the &#8216;platform&#8217; delivered with cPython,&#8230; Here&#8217;s a list of some of the mistakes you should really try to avoid when writing Python code: Remember Python comes batteries [...]]]></description>
			<content:encoded><![CDATA[<p>Lately I&#8217;ve been reading some rather unclean Python code. Maybe this is mainly because the author(s) of the code had no in-depth knowledge of the Python language itself, the &#8216;platform&#8217; delivered with cPython,&#8230; Here&#8217;s a list of some of the mistakes you should really try to avoid when writing Python code:</p>
<ul>
<li>Remember Python comes batteries included<br />
Python is shipped with  a whole bunch of standard modules implementing a broad range of functionality, including text handling, various data types, networking stuff (both low- and high-level), document processing, file archive handling, logging, etc. All these are documented in the <a href="http://docs.python.org/lib/" title="Python Library Documentation">Python Library Documentation</a>, so it is a must to browse at least through the list of available modules, so you get some notions of what you can use by default. An example: don&#8217;t introduce a dependency on <a href="http://www.twistedmatrix.com" title="Twisted">Twisted</a> to implement a very basic and simple custom HTTP server if you don&#8217;t have any performance needs, use <a href="http://docs.python.org/lib/module-BaseHTTPServer.html" title="Python BaseHTTPServer">BaseHTTPServer</a> and derivates.</li>
<li>Python is Python, don&#8217;t try to emulate bad coding patterns from other languages<br />
Python is a mature programming language which provides great flexibility, but also has some pretty specific patterns which you might not know in other languages you used before.<br />
As an example, don&#8217;t try to emulate PHP&#8217;s &#8216;include&#8217; or &#8216;require&#8217; function, at all. This could be done, somewhat, by writing the code to be included (and executed on inclusion) in a module on the top level (ie. not in functions/classes/&#8230;), and using something like &#8216;from foo import *&#8217; where you want this code to be executed. This will work, but it can become hard to maintain this. Modules are not meant to be used like this, so don&#8217;t. If you need to execute some code at some point, put it in a module as a function, import the function and call it wherever you want.</li>
<p><span id="more-59"></span></p>
<li>Don&#8217;t pollute the global namespace<br />
Do not use &#8216;from foo import *&#8217;, as this will pull in everything defined in foo, but also all modules imported in foo, and maybe even their imports, etc. Try to &#8216;import foo&#8217; and use foo.whatever, or use &#8216;from foo import whatever, somethingelse&#8217;. Explicit imports make code much more readable, and make it much easier to figure out in which module something you&#8217;re using in the current module is defined, if it&#8217;d be imported by one of your many global imports otherwise.</li>
<li>Use Pythonesque coding pattern<br />
This is very related to the previous item, obviously. Python has some well-known constructs to handle some situations. Get to know and understand them.<br />
An example: as you might know, Python has no switch/case construct. There&#8217;s a very neat way to implement this though by simply using a dict and function objects (or lambda functions). An example:</p>
<pre>def handle_one():
    return 'one'
def handle_two():
    return 'two'
def handle_default():
    return 'unknown'
cases = {
    'one': handle_one,
    'two': handle_two,
    'three': lambda: 'three',
}
for i in ('one', 'two', 'three', 'four', ):
    handler = cases.get(i, handle_default)
    print handler()</pre>
<p>We&#8217;re using the dict.get method here, which can take an optional &#8216;default&#8217; argument. Pretty neat, huh?</li>
<li>Don&#8217;t reinvent the wheel<br />
Related to #1. An example? Python contains a great &#8216;logger&#8217; module, which includes advanced functionality like logging over network, over HTTP, defining multiple logging targets, target trees,&#8230; No need to reimplement this yourself!</li>
<li>Document your code<br />
Python has this great language feature called docstrings. Sprinkle them throughout your code rigorously. Do this while writing your functions/classes, not afterwards. Everyone knows that&#8217;s extremely boring and depressing.</li>
<li>Write tests<br />
Write testing code. Python includes at least 2 ways to write tests: using standard unit tests, or using doctests, test code snippets included in your docstrings, both useful and illustrative. There&#8217;s no way to know some code refactoring went well if you can&#8217;t test the result.</li>
<li>Use error reporting wisely<br />
Python includes exception handling. Use this wisely: when something goes wrong in some function which should return a string normally to be displayed to the user, don&#8217;t just return a normal string with some error message inside, as if everything went well, but return the message packed in an exception object, so the calling code will know something went wrong (and maybe handle according to this information), whilst still being able to display the error message to the user.<br />
Next to this, subclass Exception (or a more specific Exception child class), don&#8217;t just return base Exceptions, unless in some basic circumstances. An exception class shouldn&#8217;t be huge: &#8216;class FooException(Exception): pass&#8217; cuts the job.</li>
<li>Don&#8217;t turn off error reporting during development<br />
In some cases it&#8217;s useful to make sure your application keeps on running, no matter what happens (this is eg how Twisted handles server handler exceptions). Python provides some ways to achieve this, so in case you need it you can use it, but make sure you provide a way to disable this, so you can tell your application to crash hard on exceptions during development. This way you&#8217;ll certainly notice the issue and you&#8217;ll be able to fix it early.</li>
<li>Search the web!<br />
Lots of great people wrote thousands of Python modules for lots of things. Many of them use the very liberal Python license, which allows you to re-use this code even in a close source environment. <a href="http://pypi.python.org/pypi" title="Python Package Index">Pypi</a> can be a great place to start.</li>
<li>Use Python basic built-in functions<br />
A basic example: to check whether a function parameter is of a certain type, don&#8217;t use something like &#8216;arg.__class__ == MyClass&#8217;, use &#8216;isinstance(arg, MyClass)&#8217;. Did you know isinstance&#8217;s second argument can be a tuple/list? If it is, arg&#8217;s type will be checked against all types in this list, so there&#8217;s no need to do several &#8216;isinstance&#8217; calls. Other useful built-ins are getattr/setattr/hasattr (obviously), issubclass,&#8230;</li>
<li>Use non-instance-specific class methods where useful<br />
Just like many other programming languages, Python allows you to add static methods to a class. Just decorate your method using the &#8216;staticmethod&#8217; decorator!<br />
Next to static methods, Python knows the concept of class methods, which get the class as argument. You most likely won&#8217;t need these often.</li>
<li>Learn &#8216;functional programming&#8217; basics<br />
At first it can be hard to wrap your head around functional programming patterns, but they allow a very convenient and clean way to handle several situations.</li>
<li>Don&#8217;t mess with sys.path<br />
If you need to import &#8216;external&#8217; modules, try not to mess with sys.path. Use distutils functions to discover modules, ship them as eggs,&#8230; If you want to alter sys.path anyway, try not to hardcode any &#8216;base&#8217; paths: generic paths are a major plus, and removing hardcoded path stuff can be a PITA.</li>
<li>Use an interactive shell<br />
A Python shell like <a href="http://ipython.scipy.org/" title="iPython">iPython</a> is a must-have. I&#8217;m completely addicted to the tab-completion and documentation shortcuts it provides.</li>
<li>Use a code metrics tool<br />
I personally use <a href="http://www.logilab.org/857" title="PyLint">PyLint</a> (with some rules disabled). This tool will check your code for various things: missing imports, typos, wrong variable/function/class/module naming, syntax errors,&#8230; which could be in your code even if your test suite runs fine. Maybe you can even add a hook to the VCS you&#8217;re using, which doesn&#8217;t allow you to check in code unless it got a PyLint score of eg. 7. Extremely useful!</li>
</ul>
<p>Some days ago <a href="http://www.realnitro.be" title="RealNitro">RealNitro</a> pointed me at this <a href="http://www.wordaligned.org/articles/essential-python-reading-list" title="Essential Python Reading List">list of essential Python readings</a>. &#8220;<a href="http://python.net/~goodger/projects/pycon/2007/idiomatic/" title="Idiomatic Python">Idiomatic Python</a>&#8221; is a must-read, even for experienced Python developers.</p>
<p>That&#8217;s about it for now, maybe I&#8217;ll add some more items to this list later on. If you have some other hints, comments!</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/how-not-to-write-python-code/feed/</wfw:commentRss>
		<slash:comments>41</slash:comments>
		</item>
		<item>
		<title>django-validation now includes inheritance support</title>
		<link>http://eikke.com/django-validation-now-includes-inheritance-support/</link>
		<comments>http://eikke.com/django-validation-now-includes-inheritance-support/#comments</comments>
		<pubDate>Fri, 18 Jan 2008 03:33:39 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[django-validation]]></category>
		<category><![CDATA[form]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[newforms]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[validation]]></category>

		<guid isPermaLink="false">http://eikke.com/django-validation-now-includes-inheritance-support/</guid>
		<description><![CDATA[I&#8217;m happy to announce django-validation got field type inheritance support since a couple of minutes. This means your form fields will be validated starting from the most base field type (django.newforms.Field) up to the actual field type (no multiple-inheritance supported though). In the example I wrote yesterday, when using a TestField field, this field will [...]]]></description>
			<content:encoded><![CDATA[<p>I&#8217;m happy to announce <a href="http://git.nicolast.be/?p=django-validation.git;a=summary" title="django-validation git">django-validation</a> got field type inheritance support since a couple of minutes. This means your form fields will be validated starting from the most base field type (django.newforms.Field) up to the actual field type (no multiple-inheritance supported though).</p>
<p>In <a href="http://eikke.com/django-validation-an-introduction/" title="Ikke's blog: django-validation: an introduction">the example I wrote yesterday</a>, when using a TestField field, this field will be validated as a django.newforms.Field (a &#8220;required&#8221; check will be done), then as a django.newforms.CharField (&#8220;min_length&#8221; and &#8220;max_length&#8221; checks), and finally as a TestField. A normal CharField would be validated as a Field first, then as a CharField, etc.</p>
<p>The returned errors will be a list of all errors found, starting with the most basic one (the ones found by the most general class, Field).</p>
<p>Next to this, all generated Javascript code should be namespaced now (based on Python module and class names), although there might be some bad things left, I&#8217;m no Javascript guru. The generated code might be somewhat messy.</p>
<p>Current Python code is most certainly ugly and will need more rewrites. Next to this, other field types should be added, and some tests would be nice too.</p>
<p>I made a snapshot of yesterday&#8217;s sample (with some changes, the ClientValidator API slightly changed), you can try it <a href="http://linode2.nicolast.be/files/django-validation-test.html" title="django-validation testpage">here</a>.</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/django-validation-now-includes-inheritance-support/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>django-validation: an introduction</title>
		<link>http://eikke.com/django-validation-an-introduction/</link>
		<comments>http://eikke.com/django-validation-an-introduction/#comments</comments>
		<pubDate>Tue, 15 Jan 2008 23:59:58 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[django-validation]]></category>
		<category><![CDATA[form]]></category>
		<category><![CDATA[javascript]]></category>
		<category><![CDATA[newforms]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[validation]]></category>

		<guid isPermaLink="false">http://eikke.com/django-validation-an-introduction/</guid>
		<description><![CDATA[Some time ago I wrote this generic AJAX Django form validation code. Some people didn&#8217;t like this, as AJAX should not be used to perform form validation, which is sometimes true, sometimes not, as I pointed out before. So I&#8217;ve been thinking since some time to create a Django templatetag which allows one to generate [...]]]></description>
			<content:encoded><![CDATA[<p>Some time ago I wrote this <a href="http://eikke.com/django-generic-ajax-form-validation/" title="Django generic AJAX form validation">generic AJAX Django form validation code</a>. Some people didn&#8217;t like this, as AJAX should not be used to perform form validation, which is sometimes true, sometimes not, as <a href="http://eikke.com/cellphone-bluetooth-and-reddit-rant/">I pointed out before</a>.</p>
<p>So I&#8217;ve been thinking since some time to create a <a href="http://www.djangoproject.com" title="Django">Django</a> templatetag which allows one to generate <em>client-side Javascript form validation code</em> without writing any code himself (unless using custom widgets). Today I got into it.</p>
<p><span id="more-48"></span></p>
<p>The resulting project is called <strong>django-validation</strong>. It basicly allows one to write a Newforms form class, and generate client-side validation code for this form in a template. Currently only CharField validation is implemented, more should follow soon and is easy to add.</p>
<p>Next to validation of built-in field types, one can also add code to validate custom fields. This can be done inside an inner class of the field class.</p>
<p>The current release is very alpha-grade software, a lot of enhancements could be done, and most certainly more standard field type validators should be written. Next to this, field type inheritance isn&#8217;t supported for now (so if your field type A inherits CharField, no CharField validation will be done), this should change soon.</p>
<p>Patches are, obviously, very welcome!</p>
<p>Here&#8217;s a sample how to use it. First we define a very basic form:</p>
<pre>class TestForm(forms.Form):
    first_name = forms.CharField(max_length=128)
    test = TestField(required_value=u'I like django-validation')</pre>
<p>This form uses a custom class (just for demonstration purposes). This class only performs client-side validation, no clean() function is provided, although in real field types this should obviously be added. More information can be found in the inline comments:</p>
<pre>from validation.templatetags.validation import add_error
class TestField(forms.CharField):
    def __init__(self, *args, **kwargs):
        if not 'required_value' in kwargs.keys():
            raise Exception, 'required_value should be provided'
        self.required_value = kwargs['required_value']
        del kwargs['required_value']
        super(TestField, self).__init__(*args, **kwargs)

    class ClientValidator:
        '''
        This inner class knows how to generate Javascript validation code for this field type.
        The code will be pasted inside a function block. There is at least one assigned variable, 'field',
        which is the DOM element we got to validate.

        More parameters can be defined in the 'parameters' attribute. These parameters will be added
        to the Javascript function prototype, and the value of the form field parameter value will be
        assigned.

        We need to define the field class name, so the django-validation code can generate suitable
        function names.
        '''
        parameters = ('required_value', )
        field_class = 'TestField'

        def render(self, output):
            '''
            The render function should output Javascript code to check the value of the 'field' element.
            It is called inside a Javascript function scope.

            output is a StringIO object. Normally only write or writelines calls should be used.
            '''
            output.write('value = field.value;\n')
            output.write('if(value != required_value) {\n')
            # This error message should be internationalized.
            # See the add_error documentation.
            add_error(output, 'error_msg', 'Field value should be %(value)d.', (('%(value)d', 'required_value'), ))
            output.write('    return [error_msg];\n')
            output.write('}\n')</pre>
<p>Finally, here&#8217;s how to use it inside a template (this must be one of the worse HTML/Javascript snippets I ever wrote):</p>
<pre>{% load validation %}
&lt;html&gt;
&lt;body&gt;
    &lt;form&gt;
        {{ form.as_p }}
        &lt;p&gt;&lt;input type="submit" onclick="return testform(this.form);" /&gt;
    &lt;/form&gt;
    &lt;div id="errors"&gt;&lt;/div&gt;
    {% validation_js form 'validate_testform' %}
    &lt;script type="text/javascript"&gt;
        function testform(form) {
            valid = true;
            errors = validate_testform(form);
            err = "&lt;ul&gt;";
            for(field in errors) {
                if(errors[field] != null) {
                    err += '&lt;li&gt;' + field + ': ' + errors[field][0] + '&lt;/li&gt;';
                    valid = false;
                }
            }
            err += '&lt;/ul&gt;';
            if(valid)
                err = 'Form is valid';
            document.getElementById('errors').innerHTML = err;
            return false;
        }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
<p>The current code is available in <a href="http://git.nicolast.be/?p=django-validation.git;a=summary" title="django-validation git">a git repository</a>. Enjoy!</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/django-validation-an-introduction/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>Filesystem issues and django-couchdb work</title>
		<link>http://eikke.com/filesystem-issues-and-django-couchdb-work/</link>
		<comments>http://eikke.com/filesystem-issues-and-django-couchdb-work/#comments</comments>
		<pubDate>Sun, 30 Dec 2007 01:47:22 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[Linux]]></category>
		<category><![CDATA[couchdb]]></category>
		<category><![CDATA[crash]]></category>
		<category><![CDATA[django]]></category>
		<category><![CDATA[evolution]]></category>
		<category><![CDATA[fglrx]]></category>
		<category><![CDATA[firefox]]></category>
		<category><![CDATA[gnome]]></category>
		<category><![CDATA[jfs]]></category>
		<category><![CDATA[pidgin]]></category>

		<guid isPermaLink="false">http://eikke.com/filesystem-issues-and-django-couchdb-work/</guid>
		<description><![CDATA[Last night, when shutting down my laptop (which had been up for quite a long time because of suspend/resume niceness), it crashed. I don&#8217;t know what exactly happened: pressed the GNOME&#8217;s logout button, applications were closed, until only my background was visible, then the system locked up, so I suspect my X server (some part [...]]]></description>
			<content:encoded><![CDATA[<p>Last night, when shutting down my laptop (which had been up for quite a long time because of suspend/resume niceness), it crashed. I don&#8217;t know what exactly happened: pressed the GNOME&#8217;s logout button, applications were closed, until only my background was visible, then the system locked up, so I suspect my X server (some part of it, GPU driver (fglrx) might be the bad guy). I was able to sysrq s u o, so I thought everything would be relatively fine.</p>
<p>This morning I powered on my system, and while booting, fsck of some partitions was taking a rather long time. It&#8217;s pretty normal fsck was taking somewhat longer, but not tht long&#8230; I&#8217;m using JFS on most logical volumes.</p>
<p>When the consistency check of my /home partition was done, a whole load of invalid files was displayed and later on moved to lost+found: 34068 files. Once booted, I scanned my filesystems again, rebooted, logged in, started X. Everything started fine, until I launched Evolution: it presented my the &#8216;initial run&#8217; wizard. Other issues (on first sight): all Firefox cookies were gone, and Pidgin&#8217;s blist.xml was corrupted. When using my old computer (which had frequent lockups on heavy IO usage) these last 2 issues happened a lot too, which is highly annoying, especially the blist.xml thing as I can&#8217;t see any reason to keep this file opened for long periods?</p>
<p>Luckily I was able to get my Evolution up and running again by restoring it&#8217;s GConf settings and ~/.evolution using some old backup (15/10/07). I guess I should backup more regularly&#8230; Next to this I hope I won&#8217;t find any other corrupted files, so the ones in lost+found are just Evolution email files and Firefox caches.</p>
<p>Anyway, here&#8217;s a screenshot displaying some of the initial and hackish work I&#8217;ve done this evening on integrating <a href="http://www.djangoproject.com" title="Django">Django</a> and <a href="http://www.couchdb.org" title="CouchDB">CouchDB</a> as <a href="http://eikke.com/couchdb-with-python" title="Python, CouchDB and Python">I wrote about yesterday</a>:</p>
<p><a href="http://eikke.com/filesystem-issues-and-django-couchdb-work/django-and-couchdb-first-shot-2/" rel="attachment wp-att-15" title="Django and CouchDB first shot"><img src="http://eikke.com/wp-content/uploads/2007/12/django_couchdb12.thumbnail.png" alt="Django and CouchDB first shot" /></a></p>
<p>As you can see, currently I&#8217;m able to edit fields of an object. There&#8217;s one major condition: an object with the given ID should already exist in the &#8216;database&#8217; which makes the current code rather useless, but hey <img src='http://eikke.com/wp-includes/images/smilies/icon_wink.gif' alt=';-)' class='wp-smiley' />  I&#8217;ll add object creation functionality later tonight or tomorrow.</p>
<p>Current code is very expensive too, doing way too many queries to CouchDB, mainly in client.py. This most certainly needs work.</p>
<p>Upgraded my <a href="http://www.wordpress.org" title="WordPress">WordPress</a> installation to the latest release, 2.3.2, in about 5 seconds. Got to love svn switch (although maybe I should start using git-svn for this installation too and git-pull the release branch in my local copy).</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/filesystem-issues-and-django-couchdb-work/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		</item>
		<item>
		<title>Django domain redirect middleware</title>
		<link>http://eikke.com/django-domain-redirect-middleware/</link>
		<comments>http://eikke.com/django-domain-redirect-middleware/#comments</comments>
		<pubDate>Wed, 26 Dec 2007 15:02:12 +0000</pubDate>
		<dc:creator>Nicolas</dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[django]]></category>

		<guid isPermaLink="false">http://eikke.com/2007/12/26/django-domain-redirect-middleware/</guid>
		<description><![CDATA[Most web developers know it&#8217;s possible to serve one site on several domains or subdomains, using eg. the ServerAlias Apache directive. Sometimes this behaviour is not wanted: you want your main domain to be &#8220;foo.tld&#8221;, although &#8220;www.foo.tld&#8221; should work too, and maybe even some completely different domains. This way it&#8217;s possible to have permalinks, and [...]]]></description>
			<content:encoded><![CDATA[<p>Most web developers know it&#8217;s possible to serve one site on several domains or subdomains, using eg. the <a href="http://httpd.apache.org/docs/2.0/mod/core.html#serveralias" title="Apache ServerAlias directive">ServerAlias</a> <a href="http://httpd.apache.org" title="Apache HTTPD">Apache</a> directive. Sometimes this behaviour is not wanted: you want your main domain to be &#8220;foo.tld&#8221;, although &#8220;www.foo.tld&#8221; should work too, and maybe even some completely different domains.</p>
<p>This way it&#8217;s possible to have permalinks, and you won&#8217;t get bad points from search engine spiders who don&#8217;t like the same content to be available on several URIs.</p>
<p>In <a href="http://www.djangoproject.com" title="Django">Django</a> there&#8217;s the <a href="http://www.djangoproject.com/documentation/settings/#prepend-www" title="Django PREPEND_WWW documentation">PREPEND_WWW</a> setting, which will force all requests to be redirected to www.foo.bar when coming in on foo.bar, etc. This functionality is rather limited though. As I wanted to be able to have one unique main domain in my new application, I wrote a middleware which accomplishes this in a very generic way, using the <a href="http://www.djangoproject.com/documentation/sites/" title="django.contrib.sites documentation">django.contrib.sites</a> framework. You need to add this middleware before all others in your settings file, even before the CommonMiddleware.</p>
<p>Here&#8217;s the code:</p>
<pre>from django.contrib.sites.models import Site
from django.http import HttpResponsePermanentRedirect
from django.core.urlresolvers import resolve
from django.core import urlresolvers
from django.utils.http import urlquote

class DomainRedirectMiddleware(object):
    def process_request(self, request):
        host = request.get_host()
        site = Site.objects.get_current()

        if host == site.domain:
            return None

        # Only redirect if the request is a valid path
        try:
            # One issue here: won't work when using django.contrib.flatpages
            # TODO: Make this work with flatpages <img src='http://eikke.com/wp-includes/images/smilies/icon_smile.gif' alt=':-)' class='wp-smiley' /> 
            resolve(request.path)
        except urlresolvers.Resolver404:
            return None

        new_uri = '%s://%s%s%s' % (
                request.is_secure() and 'https' or 'http',
                site.domain,
                urlquote(request.path),
                (request.method == 'GET' and len(request.GET) &gt; 0) and '?%s' % request.GET.urlencode() or ''
            )

        return HttpResponsePermanentRedirect(new_uri)</pre>
<p>Make sure you got the sites framework set up correctly when using this! As noted in the code, this doesn&#8217;t work with the <a href="http://www.djangoproject.com/documentation/flatpages/" title="django.contrib.flatpages documentation">Flatpages</a> framework yet, this is TODO.</p>
]]></content:encoded>
			<wfw:commentRss>http://eikke.com/django-domain-redirect-middleware/feed/</wfw:commentRss>
		<slash:comments>7</slash:comments>
		</item>
	</channel>
</rss>

<!-- Dynamic page generated in 0.571 seconds. -->
<!-- Cached page generated by WP-Super-Cache on 2012-12-11 21:32:53 -->
<!-- Compression = gzip -->